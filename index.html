<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Daily Stock Trends ‚Äî TSLA ¬∑ AMZN ¬∑ AAPL ¬∑ META ¬∑ GOOGL ¬∑ NVDA</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f5f5f7; --card:#fff; --fg:#1d1d1f; --muted:#6e6e73;
    --primary:#0071e3; --danger:#d70015; --ring:rgba(0,113,227,.15); --grid:rgba(0,0,0,.06);
    --shadow:0 8px 24px rgba(0,0,0,.08); --shadow-hover:0 12px 32px rgba(0,0,0,.1);
  }
  @media (prefers-color-scheme:dark){
    :root{ --bg:#000; --card:#111113; --fg:#f5f5f7; --muted:#a1a1a6; --grid:rgba(255,255,255,.08); --shadow:0 8px 24px rgba(0,0,0,.6); --shadow-hover:0 12px 32px rgba(0,0,0,.7);}
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:20px 24px 10px;max-width:1240px;margin:0 auto;}
  .title-wrap h1{margin:0;font-size:1.6rem;font-weight:700}
  .subtitle{margin:4px 0 0;color:var(--muted);font-size:.95rem}
  .toolbar{display:flex;align-items:center;gap:12px;color:var(--muted);font-weight:600}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.06)} @media (prefers-color-scheme:dark){ .pill{background:rgba(255,255,255,.08)} }
  .updated{color:var(--muted);font-size:.9rem}
  main{display:grid;grid-template-columns:repeat(auto-fit,minmax(420px,1fr));gap:36px;padding:0 24px 64px;max-width:1240px;margin:0 auto;}
  .card{background:var(--card);border-radius:24px;box-shadow:var(--shadow);padding:18px 18px 26px;transition:.25s}
  .card:hover{transform:translateY(-3px);box-shadow:var(--shadow-hover)}
  .head{display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin-bottom:10px}
  .stock-title{font-size:1.15rem;font-weight:700}
  .change{font-size:1rem;font-weight:800}
  .period-label{color:var(--muted);font-weight:700;margin-left:6px}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 14px}
  .seg{appearance:none;border:1px solid transparent;background:#0000;color:var(--fg);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:.9rem}
  .seg:hover{background:rgba(0,0,0,.05)} @media (prefers-color-scheme:dark){ .seg:hover{background:rgba(255,255,255,.08)} }
  .seg.active{border-color:var(--primary);box-shadow:0 0 0 6px var(--ring);color:var(--primary);font-weight:800}
  canvas{width:100%;height:260px!important}
  footer{text-align:center;color:var(--muted);padding:20px 0 36px}
</style>
</head>
<body>
  <header>
    <div class="title-wrap">
      <h1>üìà Daily Stock Trends</h1>
      <div class="subtitle">TSLA ¬∑ AMZN ¬∑ AAPL ¬∑ META ¬∑ GOOGL ¬∑ NVDA</div>
      <div class="updated" id="updated">Loading‚Ä¶</div>
    </div>
    <div class="toolbar">
      <div class="pill" id="today"></div>
      <div class="pill" id="snapshotPill" title="ET snapshot window"></div>
    </div>
  </header>

  <main id="grid"><p style="text-align:center;grid-column:1/-1">Loading data‚Ä¶</p></main>
  <footer>Snapshots at 9, 10, 11, 12, 13 & close (ET) ¬∑ Data served from cached snapshots</footer>

<script>
/* ‚Üê‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî SET THIS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Üí */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzCmu2pzrKQtSAVqskKLkSq-Ccj1TBOPfMSdJ7h6oOtblwpMkFY09KJHSVOtFXtoNtoLA/exec"; // e.g. https://script.google.com/macros/s/AKfycb.../exec
/* ‚Üê‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Üí */

const PERIODS = [
  { key:"data_1d", label:"1 day" },
  { key:"data_1w", label:"1 week" },
  { key:"data_1m", label:"1 month" },
  { key:"data_3m", label:"3 months" }
];

let CSS = getComputedStyle(document.documentElement);
let PRIMARY = CSS.getPropertyValue('--primary').trim();
let GRID = CSS.getPropertyValue('--grid').trim();
let MUTED = CSS.getPropertyValue('--muted').trim();

// Header date
document.getElementById("today").textContent =
  new Date().toLocaleDateString(undefined,{month:"2-digit",day:"2-digit",year:"numeric"});

// One-time load of cached snapshot (backend picks current bucket automatically)
load();

async function load() {
  try{
    const res = await fetch(WEBAPP_URL + "?_=" + Date.now()); // cache-busting
    if (!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText);
    const json = await res.json();

    // Top meta: last updated & snapshot bucket
    const updated = json.updated_at || (json.date + "T00:00:00Z");
    const bucket = json.bucket || "";
    const bucketLabel = (bucket === "CLOSE") ? "Close" : (bucket ? bucket + ":00" : "");
    document.getElementById("updated").textContent =
      "Last updated: " + new Date(updated).toLocaleString(undefined,{hour12:false}) +
      (bucketLabel ? ` ¬∑ Snapshot: ${bucketLabel} ET` : "");
    document.getElementById("snapshotPill").textContent = bucketLabel ? `Snapshot: ${bucketLabel} ET` : "‚Äî";

    // Draw cards
    const grid = document.getElementById("grid");
    grid.innerHTML = "";
    (json.stocks || []).forEach((s, idx) => grid.appendChild(makeCard(s, idx)));
  }catch(e){
    console.error(e);
    document.getElementById("grid").innerHTML =
      "<p style='text-align:center'>‚ö†Ô∏è Failed to load data</p>";
  }
}

function makeCard(stock, index){
  const wrap = el("section","card");
  const head = el("div","head");
  const title = el("div","stock-title", stock.name);
  const change = el("div","change","‚Äî%");
  const periodSpan = el("span","period-label","(1 day)");
  head.append(title, change, periodSpan);

  const btns = el("div","btns");
  let currentKey = "data_1d";
  const cv = document.createElement("canvas"); cv.id = `c-${index}`;

  PERIODS.forEach(p=>{
    const b = el("button","seg"+(p.key===currentKey?" active":""), p.label);
    b.onclick = ()=>{
      currentKey = p.key;
      [...btns.querySelectorAll(".seg")].forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      periodSpan.textContent = `(${p.label})`;
      draw(cv, stock, currentKey, change);
    };
    btns.appendChild(b);
  });

  wrap.append(head, btns, cv);
  draw(cv, stock, currentKey, change); // initial render (1 day)
  return wrap;
}

function draw(canvas, stock, key, changeEl){
  const ctx = canvas.getContext("2d");
  const dataset = normalizeSeries(stock[key] || []);
  const labels = dataset.map(p => labelOf(p.Datetime));
  const values = dataset.map(p => p.Close).filter(v => typeof v==="number" && !isNaN(v));

  // Period change %
  let pct = 0;
  if(values.length>=2 && values[0]!==0) pct = (values[values.length-1]-values[0])/values[0]*100;
  updateChange(changeEl, pct);

  if(canvas._chart) canvas._chart.destroy();
  canvas._chart = new Chart(ctx, {
    type:"line",
    data:{ labels, datasets:[{ data:values, borderColor:PRIMARY, backgroundColor:hexToRgba(PRIMARY,.12), borderWidth:2, pointRadius:0, fill:true, tension:.25 }] },
    options:{
      plugins:{ legend:{display:false}, tooltip:{mode:"index",intersect:false,callbacks:{label:(c)=>`$${(c.parsed.y??0).toFixed(2)}` }}},
      scales:{ x:{ticks:{color:MUTED,maxTicksLimit:6},grid:{color:GRID}}, y:{ticks:{color:MUTED},grid:{color:GRID}} }
    }
  });
}

function normalizeSeries(arr){ return (arr||[]).filter(p=>p && typeof p.Close==="number" && !isNaN(p.Close)); }
function updateChange(el,pct){ const up=pct>=0; el.style.color = up?PRIMARY:"#d70015"; el.textContent=`${up?"‚ñ≤":"‚ñº"} ${pct.toFixed(2)}%`; }
function labelOf(s){ return String(s).length>=16 ? String(s).slice(11,16) : s; }
function hexToRgba(hex,a){ const c=hex.replace("#",""); const v=parseInt(c.length===3?c.split("").map(x=>x+x).join(""):c,16);
  return `rgba(${(v>>16)&255},${(v>>8)&255},${v&255},${a})`; }
function el(tag,cls,txt){ const n=document.createElement(tag); if(cls) n.className=cls; if(txt!=null) n.textContent=txt; return n; }
</script>
</body>
</html>
